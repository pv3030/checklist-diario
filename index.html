<!DOCTYPE html>
<html>
<head>
    <title>Checklist Diario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        .container {
            padding: 20px;
            max-width: 90%;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        .error {
            background: #d32f2f;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .success {
            background: #388e3c;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .app-button {
            background: #ff5722;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            font-size: 18px;
        }
        .loading {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üìã</div>
        <h1>Checklist Diario</h1>
        <div id="content">
            <div class="loading">
                <p>üìç Verificando acceso...</p>
            </div>
        </div>
    </div>

    <script>
        // CIUDADES PERMITIDAS
        const ciudadesPermitidas = ["Barcelona", "Salou", "Tarragona"];
        
        // URLs
        const sheetsAppUrl = "googlesheets://docs.google.com/spreadsheets/d/1V57sHUWGfKQf2t_zqIJo-cQ2uIQ5_kx1JZcQLECa7tc/edit";
        const sheetsWebUrl = "https://docs.google.com/spreadsheets/d/1V57sHUWGfKQf2t_zqIJo-cQ2uIQ5_kx1JZcQLECa7tc/edit?usp=drivesdk";
        
        // Funci√≥n PRINCIPAL m√°s simple y confiable
        async function verificarAcceso() {
            const contentDiv = document.getElementById('content');
            
            try {
                // M√©todo M√ÅS CONFABLE: Usar ipapi.co (funciona mejor en Safari)
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                
                const ciudad = data.city;
                const ip = data.ip;
                
                console.log("üìç Ciudad detectada:", ciudad);
                console.log("üåê IP:", ip);
                
                if (!ciudad) {
                    throw new Error("No se pudo detectar la ciudad");
                }
                
                // Verificar si la ciudad est√° permitida (comparaci√≥n flexible)
                const ciudadPermitida = ciudadesPermitidas.some(ciudadPermitida => 
                    ciudad.toLowerCase().includes(ciudadPermitida.toLowerCase())
                );
                
                if (ciudadPermitida) {
                    // ‚úÖ ACCESO PERMITIDO
                    contentDiv.innerHTML = `
                        <div class="success">
                            <p>‚úÖ Ubicaci√≥n verificada: <strong>${ciudad}</strong></p>
                            <p>Haz clic para abrir:</p>
                            <a href="${sheetsAppUrl}" class="app-button" onclick="abrirEnApp()">
                                üì± ABRIR EN APP
                            </a>
                            <p><small>O <a href="${sheetsWebUrl}" style="color: white; text-decoration: underline;">abrir en navegador</a></small></p>
                        </div>
                    `;
                    
                    // Intentar abrir autom√°ticamente en app
                    setTimeout(() => {
                        window.location.href = sheetsAppUrl;
                    }, 1000);
                    
                } else {
                    // ‚ùå ACCESO DENEGADO
                    contentDiv.innerHTML = `
                        <div class="error">
                            <h2>üö´ Acceso Denegado</h2>
                            <p>Disponible solo en: <strong>${ciudadesPermitidas.join(", ")}</strong></p>
                            <p>Tu ubicaci√≥n: <strong>${ciudad}</strong></p>
                            <p><small>IP: ${ip}</small></p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Error:", error);
                
                // üÜò SI FALLA TODO, MOSTRAR OPCI√ìN MANUAL
                contentDiv.innerHTML = `
                    <div class="success">
                        <p>‚ö†Ô∏è No se pudo verificar ubicaci√≥n autom√°ticamente</p>
                        <p>Si est√°s en Barcelona, Salou o Tarragona:</p>
                        <a href="${sheetsAppUrl}" class="app-button">
                            üì± ABRIR CHECKLIST
                        </a>
                        <p><small><a href="${sheetsWebUrl}" style="color: white;">Abrir en navegador</a></small></p>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para forzar apertura en app
        function abrirEnApp() {
            window.location.href = sheetsAppUrl;
            // Si no abre en 1 segundo, ofrecer alternativa web
            setTimeout(() => {
                window.location.href = sheetsWebUrl;
            }, 1000);
        }
        
        // Ejecutar cuando cargue la p√°gina
        verificarAcceso();
    </script>
</body>
</html>
